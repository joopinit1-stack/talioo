<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talio Web</title>
<link rel="icon" href="logo.png">
<style>
/* --- CSS داخلی --- */
body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
header { display:flex; align-items:center; padding:10px; background:#075e54; color:white; }
header img { height:40px; margin-right:10px; }
#app { display:flex; flex:1; }
#sidebar { width:250px; background:#ece5dd; padding:10px; overflow:auto; }
#chatSection { flex:1; display:flex; flex-direction:column; }
#messagesContainer { flex:1; overflow:auto; padding:10px; background:#fff; }
#messageInputArea { display:flex; padding:10px; background:#f0f0f0; }
#messageInput { flex:1; padding:5px; margin-right:5px; }
#messageInputArea button { padding:5px 10px; }
ul { list-style:none; padding:0; }
li { padding:5px; cursor:pointer; }
#profileSection img { width:50px; height:50px; border-radius:50%; }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
<div id="app">
  <header>
    <img id="appLogo" src="logo.png" alt="Talio Logo">
    <h1>Talio</h1>
  </header>

  <div id="loginScreen">
    <button id="googleLogin">Login with Google</button>
  </div>

  <div id="mainApp" style="display:none;">
    <aside id="sidebar">
      <div id="profileSection">
        <img id="userPhoto" src="" alt="User Photo">
        <p id="userName"></p>
        <p id="userEmail"></p>
      </div>
      <div id="groupsList">
        <h3>Groups</h3>
        <ul id="groupItems"></ul>
      </div>
      <div id="usersList">
        <h3>Users</h3>
        <ul id="userItems"></ul>
      </div>
      <div id="adminPanel" style="display:none;">
        <h3>Admin Panel</h3>
        <input type="file" id="logoUpload">
        <button id="changeLogo">Change Logo</button>
        <button id="grantBlueTick">Grant Blue Tick</button>
      </div>
    </aside>

    <section id="chatSection">
      <div id="messagesContainer"></div>
      <div id="messageInputArea">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <input type="file" id="mediaInput">
        <button id="sendMessage">Send</button>
      </div>
    </section>
  </div>
</div>

<script>
// --- JS داخلی ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// مدیران اصلی
const admins = [
  "atoorkan@gmail.cm",
  "alitorkan60@gmail.com",
  "alitork.music@gmail.com"
];

const loginBtn = document.getElementById("googleLogin");
const mainApp = document.getElementById("mainApp");
const loginScreen = document.getElementById("loginScreen");
const userPhoto = document.getElementById("userPhoto");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");
const adminPanel = document.getElementById("adminPanel");

loginBtn.addEventListener("click", () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
});

auth.onAuthStateChanged(user => {
  if (user) {
    loginScreen.style.display = "none";
    mainApp.style.display = "flex";
    userPhoto.src = user.photoURL;
    userName.textContent = user.displayName;
    userEmail.textContent = user.email;

    if (admins.includes(user.email)) {
      adminPanel.style.display = "block";
    }

    loadUsers();
    loadGroups();
    loadMessages();
  } else {
    loginScreen.style.display = "block";
    mainApp.style.display = "none";
  }
});

function loadUsers() {
  const userItems = document.getElementById("userItems");
  db.collection("users").onSnapshot(snapshot => {
    userItems.innerHTML = "";
    snapshot.forEach(doc => {
      const li = document.createElement("li");
      li.textContent = doc.data().displayName;
      userItems.appendChild(li);
    });
  });
}

function loadGroups() {
  const groupItems = document.getElementById("groupItems");
  db.collection("groups").onSnapshot(snapshot => {
    groupItems.innerHTML = "";
    snapshot.forEach(doc => {
      const li = document.createElement("li");
      li.textContent = doc.data().name;
      groupItems.appendChild(li);
    });
  });
}

document.getElementById("sendMessage").addEventListener("click", () => {
  const msgInput = document.getElementById("messageInput");
  const mediaInput = document.getElementById("mediaInput");
  let mediaUrl = "";

  if (mediaInput.files[0]) {
    const file = mediaInput.files[0];
    const storageRef = storage.ref("media/" + file.name);
    storageRef.put(file).then(() => {
      storageRef.getDownloadURL().then(url => {
        sendMessageToDB(msgInput.value, url);
      });
    });
  } else {
    sendMessageToDB(msgInput.value, "");
  }

  msgInput.value = "";
  mediaInput.value = "";
});

function sendMessageToDB(text, mediaUrl) {
  db.collection("messages").add({
    text,
    mediaUrl,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    uid: auth.currentUser.uid,
    email: auth.currentUser.email,
    displayName: auth.currentUser.displayName
  });
}

function loadMessages() {
  const messagesContainer = document.getElementById("messagesContainer");
  db.collection("messages").orderBy("timestamp")
    .onSnapshot(snapshot => {
      messagesContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `<b>${msg.displayName}:</b> ${msg.text}`;
        if (msg.mediaUrl) div.innerHTML += `<br><a href="${msg.mediaUrl}" target="_blank">Media</a>`;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    });
}

document.getElementById("changeLogo").addEventListener("click", () => {
  const file = document.getElementById("logoUpload").files[0];
  if (file) {
    const logoRef = storage.ref("logo/" + file.name);
    logoRef.put(file).then(() => {
      logoRef.getDownloadURL().then(url => {
        document.getElementById("appLogo").src = url;
      });
    });
  }
});

document.getElementById("grantBlueTick").addEventListener("click", () => {
  const email = prompt("Enter user email to grant blue tick:");
  if (email) db.collection("users").doc(email).update({ blueTick: true });
});
</script>
</body>
</html>
